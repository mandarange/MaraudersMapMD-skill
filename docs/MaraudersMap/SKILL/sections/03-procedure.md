<!-- Section from: /Users/choi-dong-won/Desktop/devs/MaraudersMapMD-skill/SKILL.md | Lines: 50-108 -->

## Procedure

Follow these five phases in order. Each phase uses a MaraudersMapMD artifact as its primary reference.

Artifact paths (generated by the extension on save):
- AI Map: `docs/MaraudersMap/<docId>/ai-map.md`
- Section Pack: `docs/MaraudersMap/<docId>/sections/*.md`
- Search Index: `docs/MaraudersMap/<docId>/index.json`

### Sharded access rule (always-on)

- For fast lookup and reading, use the Section Pack (`sections/*.md`) as the primary source instead of the rewritten full document.
- Only open the rewritten file when you need full-context validation or to resolve cross-section ambiguity.
- The Section Pack must always be an exact shard-by-shard reflection of the rewritten document.

### Phase 1 — Baseline capture (before any rewriting)

Read the AI Map (`ai-map.md`). It contains a table of every section with line ranges, token counts, and one-line summaries. Read the Search Index (`index.json`). It lists keywords, links, and AI Hint Blocks per section. Use the Section Pack (`sections/*.md`) for quick scanning. Together these artifacts are the ground truth for what the source contains. Do not rewrite anything yet.

### Phase 2 — Create working copy

Create a `temp/` folder next to the original file. Copy the original into it as the working copy: `temp/temp_<filename>.rewritten.md`. Example: `guide.md` → `temp/temp_guide.rewritten.md`. All intermediate files go inside this `temp/` folder. All subsequent edits happen ONLY on this copy. Never modify the original.

### Phase 3 — Skeleton

Using the AI Map table as a guide, write a flat heading list in the working copy. Next to each heading note its one-line purpose. Fix heading levels so they descend without skips (single `#`, then `##`, then `###`). If the document is long, place a concise summary after the title.

### Phase 4 — Section-by-section rewrite

Open each Section Pack file (`sections/*.md`) one at a time, in order. For each section:
1. Check the Search Index entry for that section's keywords, links, and AI Hint Blocks.
2. Apply the canonical prompt rules: shorten paragraphs, convert dense prose to bullets, use tables for settings/options, keep code blocks unchanged.
3. Preserve every keyword, link, and AI Hint Block listed in the index entry.
4. Make the section self-contained. Use brief cross-references ("see Section X") instead of repeating content.

### Phase 5 — Verification and cleanup

Compare the finished output against the original Search Index:
1. Every keyword in the index must appear in the output.
2. Every AI Hint Block in the index must appear in the output.
3. Every link in the index must appear in the output.
4. Token count of the output should not significantly exceed the original (check AI Map's total).
5. Run the checklist below.

After verification passes:
1. Move `temp/temp_<filename>.rewritten.md` to the original file's directory as `<filename>.rewritten.md`.
2. Regenerate MaraudersMapMD artifacts from `<filename>.rewritten.md` so shards reflect the rewritten content.
3. Verify each `sections/*.md` shard matches its corresponding content in `<filename>.rewritten.md` (no drift).
4. Delete the `temp/` folder entirely.
5. Delete any stale MaraudersMapMD artifacts that do not match the rewritten document.
6. Confirm only the original source file, `<filename>.rewritten.md`, and the freshly generated MaraudersMapMD artifacts remain. No `temp/` folder or `temp_` files should exist.

### Sync rule — rewritten changes must update shards

If the rewritten document is edited at any time:
1. Re-run the MaraudersMapMD generation on `<filename>.rewritten.md`.
2. Replace the Section Pack and Search Index with the newly generated versions.
3. Do not continue work until shards and index exactly match the rewritten document.
